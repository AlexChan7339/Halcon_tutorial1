# 5-机器视觉应用通用流程

# 机器视觉工业通用AOI缺陷流程

1. 读取图像
2. 定位
   1. Blob定位
   2. 几何定位
3. 获取ROI（感兴趣）区域
4. 图像预处理
   1. 基于对⽐度 
      1. `scale_image (GrayImage, ImageScaled, 0.01, 0)`
      2. `MultiImage `
      3. `emphasize (ImageScaled, ImageEmphasize, 7, 7, 1) `
      4. `gray_range_rect (ImageEmphasize, ImageResult2, 11, 11) `
      5. `equ_histo_image (ImageResult2, ImageEquHisto)`
   2. ⼏何变换 
      1. .仿射变换 
      2. 极坐标变换 
      3. 投影变换
   3. 去噪声 
      1. 均值滤波 
      2. 中值滤波 
      3. ⾼斯滤波
      4. 双边滤波
   4. 抠图 
      1. ⼿画 
      2. blob逼近
   5. 傅⾥叶变换
5. 图像算法处理
   1. 读取图像
   2. 阈值
   3.  填充
   4. 打散
   5. 筛选
   6.  形态学操作 
      1. 腐蚀
      2. 膨胀
6. 结果输出

## 实例：提取瓶盖上的脏污

# 0-参数设置

1. 获取窗口的获取窗口句柄（句柄可以代表窗口）

   点击控制变量区域的`WindowHandle`，获取当前窗口的宽度和高度

```c
dev_get_window (WindowHandle)
```

2. 缺陷的最小面积

   如果后面提取出来的缺陷面积大于200，则定义为缺陷（NG品）

```c
minDefectArea :=200
```

# 1-读取图像

```c
read_image (Image, '1.bmp')
```

> **图像中的缺陷情况**
>
> <img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231831005.png" alt="image-20250823183138937" style="zoom:50%;" />

# 2-定位（Blob分析）

## 整体思路

将白色圆盖从整个图像中单独定位并提取出来，并对缺陷地方进行定位。因此，并不是整张图像上进行检测，只检测白色瓶盖区域

<img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231833019.png" alt="image-20250823183339969" style="zoom:33%;" />

> 通过肉眼可以看到，瓶盖是整个图像上灰度值最高的区域，灰度值在130以上，需要对其进行阈值分割

## 2.1-阈值分割

```c
threshold (Image, Region, 130, 255)
```

## 2.2-填充

```c
fill_up (Region, RegionFillUp)
```

## 2.3-打散

```c
connection (RegionFillUp, ConnectedRegions)
```

## 2.4-筛选特征区域

> 瓶盖区域是所有打散区域中面积最大的，可以用算子`select_shape_std`

```c
select_shape_std (RegionFillUp, SelectedRegions, 'max_area', 70)
```

`select_shape_std(Regions : SelectedRegions : Shape, Percent : )`

- `Regions`：输入要选择区域
- `SelectedRegions`: 输出希望选出的区域
- `Shape`:要选出的区域的形状特征 ,如`'max_area', 'rectangle1', 'rectangle2'`
- Percent：相似度（0.0 ≤ Percent ≤ 100.0 (lin)）

<img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231848968.png" alt="image-20250823184813897" style="zoom:33%;" />

> 此时完成定位工作

---

# 3-获取（ROI）区域图像

> ROI: region of interest

## 思路

对于筛选出来的瓶盖区域，用最小外接圆（圆心坐标和半径）生成圆区域

> 放大图像可以看到筛选区域的边缘不是规则的圆
>
> <img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231854350.png" alt="image-20250823185450302" style="zoom:33%;" />

对圆区域进行腐蚀和修饰（瓶盖外部有小齿轮，他的灰色值较低，算法会将其判定为NG，需要将区域往里面进行内缩），再虎丘原图像中外接圆生成区域的部分

## 3.1-拟合最小外接圆

```c
smallest_circle (SelectedRegions, Row, Column, Radius)
```



## 3.2-生成圆区域

```c
gen_circle (ROIRegion, Row, Column, Radius)
```

## 3.3-修整，去除瓶盖齿轮干扰区域

齿轮和瓶盖凸起地方外围大概距离15个像素块,齿轮附近干扰区域灰度值和瓶盖中心的缺陷区域灰色值很接近

<img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231906246.png" alt="image-20250823190608184" style="zoom:33%;" />

```c
erosion_circle (ROIRegion, RegionErosion1, 15)
```

## 3.4-获取原图像对应的外接圆部分

```c
reduce_domain (Image, RegionErosion1, ImageReduced)
```

# 4-图像预处理

## 思想

凸显缺陷区域，方便后续检测

## 4.1-图像增强

```c
mult_image (ImageReduced, ImageReduced, ImageResult, 0.008, 0)
```

`mult_image(Image1, Image2 : ImageResult : Mult, Add : )`:     $g' := g_1 *g_2 * mult +add$

- `Image1`:输入参数需要被乘的图片
- `image2`:输入参数拿来乘的图片
- `ImageResult`:输出参数结果图片
- `Mult`:输入矫正因子 -255.0 ≤ Mult ≤ 255.0（亮的会亮，暗的会更暗）
- `Add`:输入矫正值 -512.0 ≤ Add ≤ 512.0

# 5-图像算法处理

提取缺陷区域，整体灰度值不超过180

## 5.1-图像分割

```c
threshold (ImageResult, Region1, 0, 180)
* 不能把瓶盖的圆环像素包含在里面
```

## 5.2-打散

```c
connection (Region1, ConnectedRegions1)
```

> 异常区域中间会夹杂一些正常区域，不能将其算在异常区域中
>
> <img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508232226024.png" alt="image-20250823222614904" style="zoom:33%;" />

## 5.3-选取特征区域

```c
select_shape (ConnectedRegions1, SelectedRegions1, 'area', 'and', minDefectArea, 99999)
```

`select_shape(Regions : SelectedRegions : Features, Operation, Min, Max : )`

- Condition: $Min_i \le Features \le Max_i$

# 6-结果输出

## 思路

对异常区域进行计数，如果数量>0，则输出信息

```c
count_obj (SelectedRegions1, Number)
if(Number>0)
    * 设置显示文本颜色
    dev_set_color ('red')
    Text := 'NG'
    * 显示缺陷区域
    dev_display (SelectedRegions1)
    * 显示文本
    disp_message (WindowHandle, Text, 'image', 12, 12, '', 'false')
endif
```

`disp_message( : : WindowHandle, String, CoordSystem, Row, Column, Color, Box : )`

- disp: display

- `WindowHandle`:图形窗口“窗口句柄”

- `String`：需要现实的文本内容

- `CoordSystem`:坐标系,可选值为'window' 和'image'， 前者是在图形窗口“窗口句柄”中显示，一个是在图像区域进行显示

  也可以直接`disp_message (WindowHandle, Text, 'image', 12, 12, 'red', 'false')`,前面不用再设置文本颜色`dev_set_color ('red')`

  > **image**
  >
  > <img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231952410.png" alt="image-20250823195222201" style="zoom:33%;" />
  >
  > ---
  >
  > **window**
  >
  > <img src="https://typora3.oss-cn-shanghai.aliyuncs.com/202508231953572.png" alt="image-20250823195314464" style="zoom:50%;" />

- Row, Column： 显示位置

- Color：字体颜色

- Box：如果设置为“ true”，则文本将写在橙色框中。 如果设置为“ false”，则不会显示任何框
